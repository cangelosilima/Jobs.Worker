name: SDK Validate - PR & Push

on:
  pull_request:
    paths:
      - 'Jobs.Worker.Client/**'
      - 'backend/src/Jobs.Worker.Api/**'
      - '.github/workflows/sdk-*.yml'
  push:
    branches:
      - main
      - develop
      - 'claude/**'
    paths:
      - 'Jobs.Worker.Client/**'
      - 'backend/src/Jobs.Worker.Api/**'

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_FRAMEWORK_VERSION: '6.0.x'
  NODE_VERSION: '20.x'
  NSWAG_VERSION: '14.0.3'
  SDK_PATH: 'Jobs.Worker.Client'

jobs:
  #####################################
  # Validate SDK Build (No Publishing)
  #####################################
  validate:
    name: Validate SDK Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup .NET 6 (for NSwag)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_FRAMEWORK_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install NSwag CLI
        run: |
          dotnet tool install -g NSwag.ConsoleCore --version ${{ env.NSWAG_VERSION }}
          nswag version

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Start API for client generation
        run: |
          cd backend/src/Jobs.Worker.Api
          dotnet run --urls="https://localhost:5001" &
          API_PID=$!
          echo "API_PID=$API_PID" >> $GITHUB_ENV

          for i in {1..30}; do
            if curl -k -s -f -o /dev/null https://localhost:5001/health; then
              echo "‚úÖ API is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå API failed to start"
              exit 1
            fi
            sleep 2
          done

      - name: Generate clients
        working-directory: ${{ env.SDK_PATH }}
        run: |
          echo "üî® Generating all clients..."
          nswag run nswag-dotnet.json
          nswag run nswag-net48.json
          nswag run nswag-typescript.json
          echo "‚úÖ All clients generated"

      - name: Stop API
        if: always()
        run: |
          if [ ! -z "$API_PID" ]; then
            kill $API_PID || true
          fi

      - name: Build .NET 8 project
        working-directory: ${{ env.SDK_PATH }}
        run: |
          dotnet restore Jobs.Worker.Client.csproj
          dotnet build Jobs.Worker.Client.csproj --configuration Release --no-restore
          echo "‚úÖ .NET 8 build successful"

      - name: Build .NET Framework 4.8 project
        working-directory: ${{ env.SDK_PATH }}/Jobs.Worker.Client.Net48
        run: |
          dotnet restore Jobs.Worker.Client.Net48.csproj
          dotnet build Jobs.Worker.Client.Net48.csproj --configuration Release --no-restore
          echo "‚úÖ .NET Framework 4.8 build successful"

      - name: Build TypeScript
        working-directory: ${{ env.SDK_PATH }}
        run: |
          npm ci
          npm run build
          echo "‚úÖ TypeScript build successful"

      - name: Summary
        run: |
          echo "‚úÖ All SDK builds successful!"
          echo "   ‚îú‚îÄ .NET 8 client"
          echo "   ‚îú‚îÄ .NET Framework 4.8 client"
          echo "   ‚îî‚îÄ TypeScript client"
