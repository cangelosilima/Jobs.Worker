# GitHub Secrets Configuration

This document explains the secrets required for the SDK publishing workflows.

## Required Secrets

Navigate to: `Repository Settings > Secrets and variables > Actions > New repository secret`

### 1. NUGET_API_KEY

**Purpose:** Authenticate with NuGet.org to publish packages

**How to obtain:**

1. Go to [https://www.nuget.org/account/apikeys](https://www.nuget.org/account/apikeys)
2. Log in with your NuGet account
3. Click **"Create"**
4. Configure:
   - **Key Name**: `Jobs.Worker.Client SDK Publishing`
   - **Package owner**: Select your account/organization
   - **Glob Pattern**: `Jobs.Worker.Client*`
   - **Select Packages**: Choose specific packages or use glob pattern
   - **Expire**: 365 days (recommended)
   - **Select Scopes**:
     - ✅ Push
     - ✅ Push new packages and package versions
     - ❌ Unlist (not needed)
5. Click **"Create"**
6. **Copy the API key immediately** (you won't see it again)
7. Add to GitHub:
   - Name: `NUGET_API_KEY`
   - Value: (paste the copied API key)

**Security Notes:**
- Never commit this key to source control
- Regenerate if compromised
- Use separate keys for different projects
- Set reasonable expiration dates

---

### 2. NPM_TOKEN

**Purpose:** Authenticate with npm registry to publish packages

**How to obtain:**

1. Login to npm:
   ```bash
   npm login
   ```

2. Create an access token:
   ```bash
   npm token create
   ```

3. Choose token type:
   - For CI/CD: Select **"Automation"**
   - For personal use: Select **"Publish"**

4. Copy the token that's displayed

5. Add to GitHub:
   - Name: `NPM_TOKEN`
   - Value: (paste the token)

**Alternative method (via npm website):**

1. Go to [https://www.npmjs.com/settings/~/tokens](https://www.npmjs.com/settings/~/tokens)
2. Click **"Generate New Token"**
3. Choose **"Automation"**
4. Copy the token
5. Add to GitHub

**Security Notes:**
- Automation tokens don't expire but can be revoked
- Use `--access public` when publishing scoped packages
- Verify scope access for scoped packages (@jobs-worker/client)

---

## Verifying Secrets

### Test NuGet API Key

```bash
# Test with a dry run
dotnet nuget push path/to/package.nupkg \
  --api-key YOUR_KEY \
  --source https://api.nuget.org/v3/index.json \
  --skip-duplicate \
  --no-symbols
```

### Test npm Token

```bash
# Set token as environment variable
export NPM_TOKEN=your_token_here

# Test authentication
echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > .npmrc
npm whoami
```

---

## Secret Rotation Schedule

| Secret | Rotation Frequency | Last Rotated | Next Rotation |
|--------|-------------------|--------------|---------------|
| NUGET_API_KEY | Every 365 days | YYYY-MM-DD | YYYY-MM-DD |
| NPM_TOKEN | Every 365 days | YYYY-MM-DD | YYYY-MM-DD |

---

## Troubleshooting

### "Invalid API Key" Error (NuGet)

**Symptoms:** `401 Unauthorized` or `403 Forbidden`

**Solutions:**
1. Verify the secret name is exactly `NUGET_API_KEY`
2. Check the API key hasn't expired
3. Ensure the key has push permissions
4. Verify package name matches allowed glob pattern
5. Regenerate key if necessary

### "Authentication Failed" Error (npm)

**Symptoms:** `npm ERR! code E401` or `npm ERR! code E403`

**Solutions:**
1. Verify the secret name is exactly `NPM_TOKEN`
2. Check you're using an automation token
3. Ensure you have publish access to the scope
4. Verify package name includes correct scope (@jobs-worker/client)
5. Check token hasn't been revoked

### Secret Not Available in Workflow

**Symptoms:** Secret appears as empty in workflow logs

**Solutions:**
1. Verify secret is added at repository level (not organization)
2. Check secret name matches exactly (case-sensitive)
3. Ensure workflow has access to secrets
4. Check branch protection rules don't block secret access

---

## Security Best Practices

### ✅ DO

- ✅ Use separate API keys for different projects
- ✅ Set expiration dates on all keys/tokens
- ✅ Rotate secrets regularly (annually recommended)
- ✅ Use minimal required permissions
- ✅ Monitor secret usage in audit logs
- ✅ Revoke secrets immediately if compromised

### ❌ DON'T

- ❌ Share secrets between multiple projects
- ❌ Commit secrets to source control
- ❌ Use personal tokens for CI/CD (use automation tokens)
- ❌ Grant unnecessary permissions
- ❌ Use secrets in public/forked repositories
- ❌ Log secret values (GitHub masks them automatically)

---

## Alternative: Environment Protection Rules

For additional security, configure environment protection:

1. Go to `Settings > Environments`
2. Create environment: `production`
3. Configure protection rules:
   - ✅ Required reviewers (1+)
   - ✅ Wait timer (optional)
   - ✅ Deployment branches: `main` only
4. Add secrets to environment:
   - `NUGET_API_KEY`
   - `NPM_TOKEN`

Update workflows to use:
```yaml
jobs:
  publish:
    environment: production  # Requires approval
    steps:
      - name: Publish
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
```

---

## Secret Management Tools

For enterprise scenarios:

- **HashiCorp Vault**: Central secret management
- **AWS Secrets Manager**: Cloud-based secret storage
- **Azure Key Vault**: Microsoft cloud secret management
- **GitHub Encrypted Secrets**: Built-in (current approach)

---

## Audit Log

Keep track of secret operations:

| Date | Action | Secret | User | Notes |
|------|--------|--------|------|-------|
| 2024-12-07 | Created | NUGET_API_KEY | @user | Initial setup |
| 2024-12-07 | Created | NPM_TOKEN | @user | Initial setup |

---

## Support

For secret-related issues:

1. Check GitHub Actions logs (secrets are masked as `***`)
2. Verify secret configuration in repository settings
3. Test secrets locally using environment variables
4. Contact repository administrators for access issues

---

**Last Updated:** 2024-12-07
